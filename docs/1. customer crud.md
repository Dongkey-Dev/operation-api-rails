# Customer API Documentation

## Overview
The Customer API provides endpoints for managing customer data in the Operation Bot system. It supports various operations including listing customers with filtering, pagination, and relationship includes.

## Base URL
```
http://localhost:3000/api/v1
```

## Endpoints

### List Customers

#### Basic Request
```http
GET /customers?limit=5
```

#### Cursor-based Pagination
Use cursor-based pagination for efficient data retrieval:
```http
GET /customers?limit=5&cursor=2025-05-22T15:33:43Z
```
- `cursor`: ISO8601 timestamp format
- `limit`: Number of items per page (default: 20)

#### Response Format
```json
{
  "data": [
    {
      "id": 1,
      "user_id": 123456,
      "name": "Test User",
      "email": "test@example.com",
      "phone_number": "+821012345678",
      "last_login_at": "2025-05-22T15:33:43Z",
      "created_at": "2025-05-22T15:33:43Z",
      "updated_at": "2025-05-22T15:33:43Z"
    }
  ],
  "pagination": {
    "per_page": 5,
    "total_count": 8,
    "next_cursor": "2025-05-22T15:33:43Z"
  }
}
```

### Filtering Options

#### By User ID
```http
GET /customers?user_id=38554683
```

#### By Name
```http
GET /customers?name=test
```

#### By Email
```http
GET /customers?email=test@example.com
```

#### By Recent Login
```http
GET /customers?recent_days=7
```

#### Multiple Filters
```http
GET /customers?user_id=38554683&name=test&limit=5
```

### Including Related Data

#### Include Admin Rooms
```http
GET /customers?include=admin_rooms
```

#### Include Multiple Relations
```http
GET /customers?include=admin_rooms,room_users
```

Response will include the specified relations:
```json
{
  "data": [
    {
      "id": 1,
      "user_id": 123456,
      "name": "Test User",
      "admin_rooms": [...],
      "room_users": [...]
    }
  ],
  "pagination": {...}
}
```

### Get Single Customer

#### By ID
```http
GET /customers/1
```

#### By User ID
```http
GET /customers/by-user-id/1
```

#### By Email
```http
GET /customers/by-email/test@example.com
```

## Model Relationships

### Customer Model
```ruby
class Customer < ApplicationRecord
  # Associations
  has_many :commands, dependent: :destroy
  has_many :customer_admin_rooms, dependent: :destroy
  has_many :admin_rooms, class_name: 'OperationRoom', 
           foreign_key: 'customer_admin_user_id', 
           dependent: :nullify
  has_many :room_users, foreign_key: 'user_id', 
           primary_key: 'user_id', 
           dependent: :destroy
  has_many :operation_rooms, through: :room_users

  # Scopes
  scope :by_user, ->(user_id) { where(user_id: user_id) }
  scope :search_by_name, ->(name) { where("name LIKE ?", "%#{name}%") }
  scope :search_by_email, ->(email) { where("email LIKE ?", "%#{email}%") }
  scope :with_recent_login, ->(days) { 
    where("last_login_at > ?", Time.current - days.days) 
  }
end
```

## Implementation Notes

1. **Pagination**
   - Uses cursor-based pagination for better performance
   - Cursor is based on `created_at` timestamp
   - Returns `next_cursor` for fetching the next page

2. **Filtering**
   - All filters can be combined
   - Uses scopes for efficient query building
   - Case-insensitive search for name and email

3. **Includes**
   - Supports eager loading of related data
   - Uses snake_case for relation names
   - Multiple relations can be included in a single request

4. **Error Handling**
   - Returns appropriate HTTP status codes
   - Includes detailed error messages in the response
   - Validates all input parameters
